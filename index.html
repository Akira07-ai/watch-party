<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Watch Party</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/simple-peer@9.11.0/simplepeer.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.js"></script>

    <!-- Initialize Supabase -->
    <script>
        const supabaseUrl = process.env.REACT_APP_SUPABASE_URL;
        const supabaseKey = process.env.REACT_APP_ANON_KEY;
        const supabase = createClient(supabaseUrl, supabaseKey);
    </script>

    <!-- Your existing styles here -->
    <style>
        /* Reset and Base Styles */
        :root {
            --primary-color: #ff0000;
            --background-color: #000000;
            --text-color: #ffffff;
            --accent-color: rgba(255, 0, 0, 0.5);
            --overlay-bg: rgba(0, 0, 0, 0.8);
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 10px;
            --spacing-xs: 5px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;

            /* Character Theme Colors */
            --jinx-primary: #ff69b4;
            --vi-primary: #9370db;
            --caitlyn-primary: #4169e1;
            --ekko-primary: #32cd32;
            --silco-primary: #dc143c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Initial Forms */
        .initial-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: var(--spacing-lg);
            background: var(--background-color);
        }

        .forms-wrapper {
            background: var(--overlay-bg);
            padding: var(--spacing-lg);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 400px;
        }

        .button-group {
            display: flex;
            gap: var(--spacing-md);
            justify-content: center;
        }

        .button-group button {
            padding: var(--spacing-md) var(--spacing-lg);
            border: none;
            border-radius: var(--border-radius-md);
            background: var(--primary-color);
            color: var(--text-color);
            cursor: pointer;
            transition: transform 0.2s;
        }

        .button-group button:hover {
            transform: scale(1.05);
        }

        .form-slide {
            animation: slideIn 0.3s ease-out;
        }

        .animated-form {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .input-group input,
        .input-group select {
            padding: var(--spacing-sm);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius-sm);
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        /* Layout */
        .container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
            height: 100vh;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* Video Section */
        .video-section {
            background: var(--overlay-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .video-player {
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            position: relative;
        }

        .video-player video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Playback Controls */
        .playback-controls {
            background: var(--overlay-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .primary-controls,
        .secondary-controls,
        .volume-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-xs);
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: var(--accent-color);
            transform: scale(1.05);
        }

        /* Chat Section */
        .chat-section {
            background: var(--overlay-bg);
            border-radius: var(--border-radius-lg);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-box {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        /* Messages */
        .message {
            max-width: 85%;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--spacing-md);
            word-break: break-word;
        }

        .message.sent {
            background: var(--accent-color);
            align-self: flex-end;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.1);
            align-self: flex-start;
        }

        /* Animations */
        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr 300px;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: var(--spacing-sm);
            }

            .chat-section {
                height: 400px;
            }
        }

        /* Emoji Picker Styles */
        .emoji-picker {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: var(--overlay-bg);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-sm);
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: var(--spacing-xs);
            margin-bottom: var(--spacing-xs);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .emoji-picker span {
            cursor: pointer;
            padding: var(--spacing-xs);
            text-align: center;
            transition: transform 0.2s;
        }

        .emoji-picker span:hover {
            transform: scale(1.2);
        }

        .emoji-button {
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            padding: var(--spacing-xs);
        }

        /* Reactions */
        .reaction-bar {
            display: flex;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            margin-top: var(--spacing-sm);
        }

        .reaction-btn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            transition: all 0.3s;
        }

        .reaction-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
        }

        .floating-reaction {
            position: absolute;
            bottom: 20px;
            font-size: 2em;
            animation: floatUp 1s ease-out forwards;
            pointer-events: none;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
        }

        .quick-action-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: var(--text-color);
            padding: var(--spacing-sm);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-action-btn:hover {
            background: var(--accent-color);
            transform: scale(1.1);
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-100px) scale(1.5); opacity: 0; }
        }

        /* Character Background Themes */
        .theme-jinx {
            background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                url('https://raw.githubusercontent.com/yourusername/arcane-watch/main/assets/jinx-bg.jpg');
            --primary-color: var(--jinx-primary);
        }

        .theme-vi {
            background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                url('https://raw.githubusercontent.com/yourusername/arcane-watch/main/assets/vi-bg.jpg');
            --primary-color: var(--vi-primary);
        }

        .theme-caitlyn {
            background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                url('https://raw.githubusercontent.com/yourusername/arcane-watch/main/assets/caitlyn-bg.jpg');
            --primary-color: var(--caitlyn-primary);
        }

        .theme-ekko {
            background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                url('https://raw.githubusercontent.com/yourusername/arcane-watch/main/assets/ekko-bg.jpg');
            --primary-color: var(--ekko-primary);
        }

        .theme-silco {
            background-image: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)),
                url('https://raw.githubusercontent.com/yourusername/arcane-watch/main/assets/silco-bg.jpg');
            --primary-color: var(--silco-primary);
        }

        /* Theme Selector Styles */
        .theme-selector {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--overlay-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            z-index: 1000;
        }

        .theme-option {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            cursor: pointer;
            border-radius: var(--border-radius-sm);
            transition: all 0.3s;
        }

        .theme-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .theme-option img {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            object-fit: cover;
        }

        .theme-option.active {
            background: var(--primary-color);
        }
    </style>
</head>
<body>
    <!-- Initial Forms Container -->
    <div id="initialForms" class="initial-container">
        <div class="forms-wrapper">
            <div id="initialButtons" class="button-group">
                <button class="create-room-btn">Create Room</button>
                <button class="join-room-btn">Join Room</button>
            </div>

            <!-- Create Room Form -->
            <div id="createRoomForm" class="form-slide" style="display: none;">
                <h3>Create New Room</h3>
                <form id="createRoomFormElement" class="animated-form">
                    <div class="input-group">
                        <input type="text" id="newUserName" placeholder="Your Display Name" required>
                    </div>
                    <div class="input-group">
                        <input type="text" id="newMeetingName" placeholder="Meeting Name" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="newRoomPassword" placeholder="Room Password" required>
                    </div>
                    <button type="submit">Create Room</button>
                    <button type="button" class="back-btn">Back</button>
                </form>
            </div>

            <!-- Join Room Form -->
            <div id="joinRoomForm" class="form-slide" style="display: none;">
                <h3>Join Existing Room</h3>
                <form id="joinRoomFormElement" class="animated-form">
                    <div class="input-group">
                        <input type="text" id="userName" placeholder="Your Display Name" required>
                    </div>
                    <div class="input-group">
                        <input type="text" id="meetingName" placeholder="Meeting Name" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="roomPassword" placeholder="Room Password" required>
                    </div>
                    <button type="submit">Join Room</button>
                    <button type="button" class="back-btn">Back</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Theme Selector -->
    <div class="theme-selector">
        <h3>Choose Character Theme</h3>
        <div class="theme-option" onclick="setTheme('jinx')">
            <img src="jinx.png" alt="Jinx">
            <span>Jinx</span>
        </div>
        <div class="theme-option" onclick="setTheme('xi')">
            <img src="xi.jpg" alt="xi">
            <span>xi</span>
        </div>
        <div class="theme-option" onclick="setTheme('caitlyn')">
            <img src="caitlyn.jpg" alt="Caitlyn">
            <span>Caitlyn</span>
        </div>
        <div class="theme-option" onclick="setTheme('ekko')">
            <img src="ekko.jpg" alt="Ekko">
            <span>Ekko</span>
        </div>
        <div class="theme-option" onclick="setTheme('silco')">
            <img src="silco.webp" alt="Silco">
            <span>Silco</span>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container" style="display: none;">
        <!-- Your existing container content -->
        <div class="video-section">
            <div id="videoPlayer" class="video-player"></div>
            <div class="playback-controls">
                <div class="primary-controls">
                    <button onclick="videoControls.play()" class="control-btn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button onclick="videoControls.pause()" class="control-btn">
                        <i class="fas fa-pause"></i>
                    </button>
                    <input type="range" id="timelineSlider" min="0" max="100" value="0">
                    <span id="currentTime">00:00</span> / <span id="duration">00:00</span>
                </div>
                
                <div class="secondary-controls">
                    <button onclick="videoControls.seek(videoElement.currentTime - 10)" class="control-btn">
                        <i class="fas fa-backward"></i> 10s
                    </button>
                    <select onchange="videoControls.setPlaybackSpeed(this.value)">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                    <button onclick="videoControls.seek(videoElement.currentTime + 10)" class="control-btn">
                        10s <i class="fas fa-forward"></i>
                    </button>
                </div>

                <div class="volume-controls">
                    <i class="fas fa-volume-up"></i>
                    <input type="range" 
                           onchange="videoControls.setVolume(this.value)" 
                           min="0" max="1" step="0.1" value="1">
                    <button onclick="videoControls.toggleMute()" class="control-btn">
                        <i class="fas fa-volume-mute"></i>
                    </button>
                </div>
            </div>
        </div>

        <div class="chat-section">
            <div id="chatBox" class="chat-box"></div>
            <div class="message-input-container">
                <input type="text" id="messageInput" placeholder="Type a message...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Main JavaScript -->
    <script>
        // Global Variables
        let roomId;
        let userName;
        let isAdmin = false;
        let peerConnections = {};
        let screenStream = null;
        let videoElement = null;
        let isScreenSharing = false;
        let currentTheme = 'default';
        let chatChannel;
        let videoStateChannel;

        const characterImages = {
            backgrounds: {
                jinx: 'jinx.png',
                vi: 'vi.jpg',
                caitlyn: 'caitlyn.jpg',
                ekko: 'ekko.jpg',
                silco: 'silco.webp'
            },
            avatars: {
                jinx: 'jinx.jpg',
                vi: 'vi.jpg',
                caitlyn: 'caitlyn.jpg',
                ekko: 'ekko.jpg',
                silco: 'silco.webp'
            }
        };

        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            // Get button elements
            const createRoomBtn = document.querySelector('.create-room-btn');
            const joinRoomBtn = document.querySelector('.join-room-btn');
            const backBtns = document.querySelectorAll('.back-btn');
            const createRoomForm = document.getElementById('createRoomFormElement');
            const joinRoomForm = document.getElementById('joinRoomFormElement');

            // Debug log elements
            console.log('Elements found:', {
                createRoomBtn,
                joinRoomBtn,
                backBtns,
                createRoomForm,
                joinRoomForm
            });

            // Add click event listeners
            if(createRoomBtn) {
                createRoomBtn.addEventListener('click', function() {
                    console.log('Create Room button clicked');
                    document.getElementById('initialButtons').style.display = 'none';
                    document.getElementById('createRoomForm').style.display = 'block';
                });
            }

            if(joinRoomBtn) {
                joinRoomBtn.addEventListener('click', function() {
                    console.log('Join Room button clicked');
                    document.getElementById('initialButtons').style.display = 'none';
                    document.getElementById('joinRoomForm').style.display = 'block';
                });
            }

            // Add event listeners to all back buttons
            backBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    console.log('Back button clicked');
                    document.getElementById('initialButtons').style.display = 'flex';
                    document.getElementById('createRoomForm').style.display = 'none';
                    document.getElementById('joinRoomForm').style.display = 'none';
                });
            });

            // Form submit handlers
            if(createRoomForm) {
                createRoomForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('Create Room form submitted');
                    await handleCreateRoom(e);
                });
            }

            if(joinRoomForm) {
                joinRoomForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    console.log('Join Room form submitted');
                    await handleJoinRoom(e);
                });
            }
        });

        // Room Management Functions
        async function handleCreateRoom(event) {
            event.preventDefault();
            try {
                userName = document.getElementById('newUserName').value;
                const roomName = document.getElementById('newMeetingName').value;
                const password = document.getElementById('newRoomPassword').value;

                const { data, error } = await supabase
                    .from('rooms')
                    .insert([{
                        name: roomName,
                        password: password,
                        admin_name: userName,
                        created_at: new Date().toISOString()
                    }])
                    .select()
                    .single();

                if (error) throw error;

                roomId = data.id;
                isAdmin = true;
                enterRoom();
            } catch (error) {
                showError('Failed to create room: ' + error.message);
            }
        }

        async function handleJoinRoom(event) {
            event.preventDefault();
            try {
                userName = document.getElementById('userName').value;
                const roomName = document.getElementById('meetingName').value;
                const password = document.getElementById('roomPassword').value;

                const { data, error } = await supabase
                    .from('rooms')
                    .select()
                    .eq('name', roomName)
                    .eq('password', password)
                    .single();

                if (error) throw new Error('Invalid room name or password');

                roomId = data.id;
                isAdmin = data.admin_name === userName;
                enterRoom();
            } catch (error) {
                showError('Failed to join room: ' + error.message);
            }
        }

        function enterRoom() {
            document.getElementById('initialForms').style.display = 'none';
            document.querySelector('.container').style.display = 'grid';
            if (isAdmin) {
                document.getElementById('adminControls').style.display = 'block';
            }
            initializeRoom();
        }

        // Utility Functions
        function showError(message) {
            Toastify({
                text: message,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "#ff4444",
            }).showToast();
        }

        function showSuccess(message) {
            Toastify({
                text: message,
                duration: 3000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "#44ff44",
            }).showToast();
        }

        // Initialize Room
        async function initializeRoom() {
            try {
                setupVideoPlayer();
                setupChat();
                setupEmojiPicker();
                setupReactions();
                setupQuickActions();
                showSuccess('Room initialized successfully');
            } catch (error) {
                showError('Failed to initialize room: ' + error.message);
            }
        }

        // Add error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            showError('An unexpected error occurred');
        });

        // Video Controls
        function setupVideoPlayer() {
            videoElement = document.createElement('video');
            videoElement.id = 'mainVideo';
            document.getElementById('videoPlayer').appendChild(videoElement);
            
            // Add video event listeners
            videoElement.addEventListener('loadedmetadata', () => {
                document.getElementById('duration').textContent = formatTime(videoElement.duration);
            });

            videoElement.addEventListener('timeupdate', () => {
                document.getElementById('currentTime').textContent = formatTime(videoElement.currentTime);
                document.getElementById('timelineSlider').value = 
                    (videoElement.currentTime / videoElement.duration) * 100;
            });

            // Initialize controls
            setupVideoControls();
        }

        const videoControls = {
            play: async function() {
                if (videoElement) {
                    await videoElement.play();
                    broadcastVideoState('play');
                }
            },

            pause: async function() {
                if (videoElement) {
                    videoElement.pause();
                    broadcastVideoState('pause');
                }
            },

            seek: function(time) {
                if (videoElement) {
                    videoElement.currentTime = time;
                    broadcastVideoState('seek', time);
                }
            },

            setVolume: function(volume) {
                if (videoElement) {
                    videoElement.volume = volume;
                }
            },

            setPlaybackSpeed: function(speed) {
                if (videoElement) {
                    videoElement.playbackRate = speed;
                    broadcastVideoState('speed', speed);
                }
            },

            toggleMute: function() {
                if (videoElement) {
                    videoElement.muted = !videoElement.muted;
                }
            },

            takeSnapshot: function() {
                if (!videoElement) return;
                
                const canvas = document.createElement('canvas');
                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(videoElement, 0, 0);
                
                const link = document.createElement('a');
                link.download = 'snapshot.png';
                link.href = canvas.toDataURL();
                link.click();
            }
        };

        // Screen Sharing
        async function startScreenShare() {
            try {
                screenStream = await navigator.mediaDevices.getDisplayMedia({
                    video: true,
                    audio: true
                });
                videoElement.srcObject = screenStream;
                document.getElementById('startScreenShare').style.display = 'none';
                document.getElementById('stopScreenShare').style.display = 'block';
                isScreenSharing = true;
                showSuccess('Screen sharing started');
            } catch (error) {
                showError('Failed to start screen sharing: ' + error.message);
            }
        }

        function stopScreenShare() {
            if (screenStream) {
                screenStream.getTracks().forEach(track => track.stop());
                screenStream = null;
                videoElement.srcObject = null;
                document.getElementById('startScreenShare').style.display = 'block';
                document.getElementById('stopScreenShare').style.display = 'none';
                isScreenSharing = false;
                showSuccess('Screen sharing stopped');
            }
        }

        // Chat Functions
        function setupChat() {
            const messageInput = document.getElementById('messageInput');
            const chatBox = document.getElementById('chatBox');

            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Initialize emoji picker
            setupEmojiPicker();
        }

        async function sendMessage(content = null, type = 'text') {
            try {
                const messageInput = document.getElementById('messageInput');
                const messageContent = content || messageInput.value.trim();
                
                if (!messageContent) return;

                await chatChannel.send({
                    type: 'broadcast',
                    event: 'message',
                    payload: {
                        type,
                        content: messageContent,
                        sender: userName,
                        timestamp: new Date().toISOString()
                    }
                });

                if (type === 'text') {
                    messageInput.value = '';
                }

                showSuccess('Message sent');
            } catch (error) {
                showError('Failed to send message: ' + error.message);
            }
        }

        function handleNewMessage(payload) {
            const { type, content, sender, timestamp } = payload;
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender === userName ? 'sent' : 'received'}`;

            switch (type) {
                case 'text':
                    messageDiv.innerHTML = `
                        <span class="sender">${sender}</span>
                        <span class="content">${escapeHtml(content)}</span>
                        <span class="timestamp">${formatTimestamp(timestamp)}</span>
                    `;
                    break;
                case 'file':
                    messageDiv.innerHTML = `
                        <span class="sender">${sender}</span>
                        <a href="${content.url}" target="_blank" class="file-link">
                            ðŸ“Ž ${escapeHtml(content.name)} (${formatFileSize(content.size)})
                        </a>
                        <span class="timestamp">${formatTimestamp(timestamp)}</span>
                    `;
                    break;
            }

            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        // File Sharing
        async function handleFileShare(event) {
            const files = event.target.files || event.dataTransfer.files;
            
            for (const file of files) {
                try {
                    const { data, error } = await supabase.storage
                        .from('shared-files')
                        .upload(`${roomId}/${file.name}`, file);

                    if (error) throw error;

                    const { data: { publicUrl } } = supabase.storage
                        .from('shared-files')
                        .getPublicUrl(`${roomId}/${file.name}`);

                    await sendMessage({
                        url: publicUrl,
                        name: file.name,
                        size: file.size
                    }, 'file');

                    showSuccess('File shared successfully');
                } catch (error) {
                    showError(`Failed to share file: ${error.message}`);
                }
            }
        }

        // Utility Functions
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            seconds = Math.floor(seconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Emoji Picker Setup
        function setupEmojiPicker() {
            const emojiButton = document.createElement('button');
            emojiButton.className = 'emoji-button';
            emojiButton.innerHTML = 'ðŸ˜Š';
            emojiButton.onclick = toggleEmojiPicker;

            const messageInputContainer = document.querySelector('.message-input-container');
            messageInputContainer.insertBefore(emojiButton, messageInputContainer.firstChild);

            // Create emoji picker container
            const emojiPicker = document.createElement('div');
            emojiPicker.id = 'emojiPicker';
            emojiPicker.className = 'emoji-picker';
            emojiPicker.style.display = 'none';
            
            // Add common emojis
            const commonEmojis = ['ðŸ˜Š', 'ðŸ˜‚', 'â¤ï¸', 'ðŸ‘', 'ðŸ˜Ž', 'ðŸŽ‰', 'ðŸ”¥', 'ðŸ˜¢', 'ðŸ¤”', 'ðŸ˜', 
                                'ðŸ‘‹', 'ðŸ™Œ', 'ðŸ‘', 'ðŸŽ®', 'ðŸ¿', 'ðŸŽ¬', 'â°', 'â­', 'ðŸŽµ', 'ðŸ’¬'];
            
            commonEmojis.forEach(emoji => {
                const emojiSpan = document.createElement('span');
                emojiSpan.textContent = emoji;
                emojiSpan.onclick = () => addEmoji(emoji);
                emojiPicker.appendChild(emojiSpan);
            });

            messageInputContainer.appendChild(emojiPicker);
        }

        function toggleEmojiPicker() {
            const picker = document.getElementById('emojiPicker');
            picker.style.display = picker.style.display === 'none' ? 'grid' : 'none';
        }

        function addEmoji(emoji) {
            const messageInput = document.getElementById('messageInput');
            messageInput.value += emoji;
            messageInput.focus();
        }

        // Reactions System
        function setupReactions() {
            const reactionBar = document.createElement('div');
            reactionBar.className = 'reaction-bar';
            
            const reactions = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ‘'];
            
            reactions.forEach(reaction => {
                const button = document.createElement('button');
                button.className = 'reaction-btn';
                button.innerHTML = `${reaction} <span class="reaction-count">0</span>`;
                button.onclick = () => sendReaction(reaction);
                reactionBar.appendChild(button);
            });

            document.querySelector('.video-section').appendChild(reactionBar);
        }

        async function sendReaction(emoji) {
            try {
                const reaction = {
                    emoji,
                    sender: userName,
                    timestamp: new Date().toISOString()
                };

                await chatChannel.send({
                    type: 'broadcast',
                    event: 'reaction',
                    payload: reaction
                });

                showReactionAnimation(emoji);
            } catch (error) {
                showError('Failed to send reaction: ' + error.message);
            }
        }

        function showReactionAnimation(emoji) {
            const reaction = document.createElement('div');
            reaction.className = 'floating-reaction';
            reaction.textContent = emoji;
            
            const videoPlayer = document.querySelector('.video-player');
            videoPlayer.appendChild(reaction);

            // Random position from bottom
            const startX = Math.random() * (videoPlayer.offsetWidth - 50);
            reaction.style.left = `${startX}px`;

            // Animate and remove
            setTimeout(() => reaction.remove(), 1000);
        }

        // Quick Actions Menu
        function setupQuickActions() {
            const quickActions = document.createElement('div');
            quickActions.className = 'quick-actions';
            
            const actions = [
                { icon: 'fa-camera', label: 'Screenshot', action: videoControls.takeSnapshot },
                { icon: 'fa-external-link-alt', label: 'PiP', action: togglePiP },
                { icon: 'fa-closed-captioning', label: 'CC', action: toggleCaptions },
                { icon: 'fa-expand', label: 'Fullscreen', action: toggleFullscreen }
            ];

            actions.forEach(({ icon, label, action }) => {
                const button = document.createElement('button');
                button.className = 'quick-action-btn';
                button.innerHTML = `<i class="fas ${icon}"></i>`;
                button.title = label;
                button.onclick = action;
                quickActions.appendChild(button);
            });

            document.querySelector('.video-section').appendChild(quickActions);
        }

        // Picture in Picture
        async function togglePiP() {
            try {
                if (document.pictureInPictureElement) {
                    await document.exitPictureInPicture();
                } else if (document.pictureInPictureEnabled) {
                    await videoElement.requestPictureInPicture();
                }
            } catch (error) {
                showError('PiP failed: ' + error.message);
            }
        }

        // Captions
        async function toggleCaptions() {
            try {
                if (videoElement.textTracks.length === 0) {
                    const track = videoElement.addTextTrack('captions', 'English', 'en');
                    track.mode = 'showing';
                } else {
                    const track = videoElement.textTracks[0];
                    track.mode = track.mode === 'showing' ? 'hidden' : 'showing';
                }
            } catch (error) {
                showError('Caption toggle failed: ' + error.message);
            }
        }

        // Fullscreen
        function toggleFullscreen() {
            try {
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                } else {
                    const videoContainer = document.querySelector('.video-section');
                    videoContainer.requestFullscreen();
                }
            } catch (error) {
                showError('Fullscreen toggle failed: ' + error.message);
            }
        }

        // Theme Management
        const themes = {
            jinx: {
                primary: '#ff69b4',
                background: '#000000',
                text: '#ffffff',
                characterName: 'Jinx',
                quote: "I'm crazy! Got a doctor's note."
            },
            vi: {
                primary: '#9370db',
                background: '#000000',
                text: '#ffffff',
                characterName: 'Vi',
                quote: "I can handle myself."
            },
            caitlyn: {
                primary: '#4169e1',
                background: '#000000',
                text: '#ffffff',
                characterName: 'Caitlyn',
                quote: "I'm on the case."
            },
            ekko: {
                primary: '#32cd32',
                background: '#000000',
                text: '#ffffff',
                characterName: 'Ekko',
                quote: "Time to make history."
            },
            silco: {
                primary: '#dc143c',
                background: '#000000',
                text: '#ffffff',
                characterName: 'Silco',
                quote: "Loyalty. That's what matters."
            }
        };

        function setTheme(themeName) {
            // Remove all existing theme classes
            document.body.classList.remove('theme-jinx', 'theme-vi', 'theme-caitlyn', 'theme-ekko', 'theme-silco');
            
            // Add new theme class
            document.body.classList.add(`theme-${themeName}`);
            
            // Update theme variables
            const theme = themes[themeName];
            document.documentElement.style.setProperty('--primary-color', theme.primary);
            document.documentElement.style.setProperty('--background-color', theme.background);
            document.documentElement.style.setProperty('--text-color', theme.text);

            // Update active state in theme selector
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            document.querySelector(`.theme-option[onclick="setTheme('${themeName}')"]`).classList.add('active');

            // Show character quote
            showCharacterQuote(theme.characterName, theme.quote);
        }

        function showCharacterQuote(character, quote) {
            Toastify({
                text: `${character}: "${quote}"`,
                duration: 3000,
                gravity: "top",
                position: "center",
                backgroundColor: "var(--primary-color)",
                className: "character-quote"
            }).showToast();
        }

        // Initialize default theme
        document.addEventListener('DOMContentLoaded', () => {
            setTheme('jinx'); // Set default theme
        });
    </script>
</body>
</html>
