<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Watch Party</title>
    
    <!-- Supabase JS -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <!-- Initialize Supabase First -->
    <script>
        // Initialize Supabase client
        const supabaseUrl = 'https://pqqxlilkkqnhfsnixtwa.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBxcXhsaWxra3FuaGZzbml4dHdhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzExNjI4MDYsImV4cCI6MjA0NjczODgwNn0.XAGbRLnbpfitg9QjGLNoee1fxp57Li4ExB4_BxwUvM4'
        const supabase = createClient(supabaseUrl, supabaseKey)
    </script>

    <style>
        /* Reset and Base Styles */
        :root {
            --primary-color: #ff0000;
            --background-color: #000000;
            --text-color: #ffffff;
            --accent-color: rgba(255, 0, 0, 0.5);
            --overlay-bg: rgba(0, 0, 0, 0.8);
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 10px;
            --spacing-xs: 5px;
            --spacing-sm: 10px;
            --spacing-md: 15px;
            --spacing-lg: 20px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            background: var(--background-color);
            color: var(--text-color);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Layout */
        .container {
            display: grid;
            grid-template-columns: 250px 1fr 300px;
            gap: var(--spacing-lg);
            padding: var(--spacing-lg);
            height: 100vh;
            max-width: 1800px;
            margin: 0 auto;
        }

        /* User Section Styles */
        .user-section {
            background: var(--overlay-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
        }

        .user-list {
            margin-top: var(--spacing-md);
        }

        .user-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            background: rgba(255, 255, 255, 0.1);
            margin-bottom: var(--spacing-xs);
        }

        /* Video Section Styles */
        .video-section {
            background: var(--overlay-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-md);
        }

        .video-player {
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--border-radius-md);
            overflow: hidden;
            position: relative;
        }

        .video-player video {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        /* Video Controls */
        .playback-controls {
            background: var(--overlay-bg);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            display: none;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .primary-controls,
        .secondary-controls,
        .volume-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-xs);
        }

        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: var(--border-radius-sm);
            padding: var(--spacing-sm) var(--spacing-md);
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: var(--accent-color);
            transform: scale(1.05);
        }

        /* Video Grid */
        .video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .video-container {
            position: relative;
            aspect-ratio: 16/9;
            background: #000;
            border-radius: var(--border-radius-md);
            overflow: hidden;
        }

        .video-container video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .name-tag {
            position: absolute;
            bottom: var(--spacing-sm);
            left: var(--spacing-sm);
            background: var(--overlay-bg);
            padding: var(--spacing-xs) var(--spacing-sm);
            border-radius: var(--border-radius-sm);
            font-size: 12px;
        }

        /* Chat Section */
        .chat-section {
            background: var(--overlay-bg);
            border-radius: var(--border-radius-lg);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .chat-tabs {
            display: flex;
            gap: 2px;
            padding: var(--spacing-sm) var(--spacing-sm) 0;
        }

        .chat-tabs button {
            padding: var(--spacing-sm) var(--spacing-md);
            border: none;
            border-radius: var(--border-radius-sm) var(--border-radius-sm) 0 0;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            cursor: pointer;
        }

        .chat-tabs button.active {
            background: var(--accent-color);
        }

        .chat-box {
            flex-grow: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        /* Messages */
        .message {
            max-width: 85%;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--spacing-md);
            word-break: break-word;
        }

        .message.sent {
            background: var(--accent-color);
            align-self: flex-end;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.1);
            align-self: flex-start;
        }

        /* File Sharing */
        .files-box {
            display: none;
            height: 100%;
            padding: var(--spacing-md);
            overflow-y: auto;
        }

        .files-box.active {
            display: block;
        }

        .upload-area {
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            text-align: center;
            transition: all 0.3s;
        }

        .upload-area.drag-over {
            border-color: var(--primary-color);
            background: rgba(255, 0, 0, 0.1);
        }

        /* Reactions */
        .reaction-bar {
            display: flex;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
        }

        .reaction-btn {
            font-size: 20px;
            padding: var(--spacing-xs) var(--spacing-sm);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .reaction-btn:hover {
            transform: scale(1.2);
        }

        .floating-reaction {
            position: absolute;
            font-size: 30px;
            pointer-events: none;
            animation: floatUp 2s ease-out forwards;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--overlay-bg);
            z-index: 1000;
        }

        .modal-content {
            background: #111;
            margin: 10% auto;
            padding: var(--spacing-lg);
            width: 90%;
            max-width: 500px;
            border-radius: var(--border-radius-lg);
            position: relative;
            box-shadow: 0 0 20px rgba(255, 0, 0, 0.3);
        }

        /* Animations */
        @keyframes floatUp {
            0% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px) scale(1.5);
                opacity: 0;
            }
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr 300px;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                padding: var(--spacing-sm);
            }

            .chat-section {
                height: 400px;
            }

            .video-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }

            .modal-content {
                width: 95%;
                margin: 5% auto;
            }
        }
    </style>

    <!-- Add new dependencies -->
    <script src="https://unpkg.com/simple-peer@9.11.0/simplepeer.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.js"></script>
</head>
<body>
    <div class="character-images">
        <img src="images/characters/jinx.png" alt="" class="character jinx">
        <img src="images/characters/vi.jpg" alt="" class="character vi">
        <img src="images/characters/caitlyn.jpg" alt="" class="character caitlyn">
        <img src="images/characters/silco.webp" alt="" class="character silco">
    </div>

    <!-- Login Container -->
    <div class="login-container" id="loginContainer">
        <div class="login-form">
            <h2>Arcane Watch Party</h2>
            
            <!-- Initial Buttons -->
            <div id="initialButtons" class="fade-in">
                <button class="pulse" onclick="showCreateRoomForm()">Create Room</button>
                <button class="pulse" onclick="showJoinRoomForm()">Join Room</button>
            </div>

            <!-- Create Room Form -->
            <div id="createRoomForm" class="form-slide" style="display: none;">
                <h3>Create New Room</h3>
                <form onsubmit="handleCreateRoom(event)" class="animated-form">
                    <div class="input-group">
                        <input type="text" id="newUserName" placeholder="Your Display Name" required>
                    </div>
                    <div class="input-group">
                        <input type="text" id="newMeetingName" placeholder="Set Meeting Name" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="newRoomPassword" placeholder="Set Room Password" required>
                    </div>
                    <button type="submit">Create Room</button>
                    <button type="button" onclick="showInitialButtons()" class="back-btn">Back</button>
                </form>
            </div>

            <!-- Join Room Form -->
            <div id="joinRoomForm" class="form-slide" style="display: none;">
                <h3>Join Existing Room</h3>
                <form onsubmit="handleJoinRoom(event)" class="animated-form">
                    <div class="input-group">
                        <input type="text" id="userName" placeholder="Your Display Name" required>
                    </div>
                    <div class="input-group">
                        <input type="text" id="meetingName" placeholder="Meeting Name" required>
                    </div>
                    <div class="input-group">
                        <input type="password" id="roomPassword" placeholder="Room Password" required>
                    </div>
                    <button type="submit">Join Room</button>
                    <button type="button" onclick="showInitialButtons()" class="back-btn">Back</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Updated User Section -->
        <div class="user-section">
            <h3>Users in Room</h3>
            <div id="userList" class="user-list"></div>
            
            <!-- Video Chat Grid -->
            <div id="videoGrid" class="video-grid"></div>
            
            <div id="adminControls" class="admin-controls" style="display: none;">
                <h4>Admin Controls</h4>
                <button onclick="toggleRoomSettings()">Room Settings</button>
                <button onclick="toggleAnalytics()">View Analytics</button>
            </div>
        </div>

        <!-- Updated Video Section -->
        <div class="video-section">
            <!-- Theme Selector -->
            <div class="theme-selector">
                <select onchange="applyTheme(this.value)">
                    <option value="default">Default Theme</option>
                    <option value="light">Light Theme</option>
                    <option value="neon">Neon Theme</option>
                </select>
            </div>

            <div class="screen-share-controls">
                <button id="startScreenShare" onclick="startScreenShare()" class="control-btn">
                    <i class="fas fa-desktop"></i> Share Screen
                </button>
                <button id="stopScreenShare" onclick="stopScreenShare()" class="control-btn" style="display: none;">
                    <i class="fas fa-stop"></i> Stop Sharing
                </button>
                <button onclick="togglePiP()" class="control-btn">
                    <i class="fas fa-external-link-alt"></i> Picture-in-Picture
                </button>
            </div>

            <div id="videoPlayer" class="video-player">
                <!-- Video content will be added here -->
            </div>

            <!-- Enhanced Playback Controls -->
            <div class="playback-controls" style="display: none;">
                <div class="primary-controls">
                    <button onclick="syncPlay()" class="control-btn">
                        <i class="fas fa-play"></i>
                    </button>
                    <button onclick="syncPause()" class="control-btn">
                        <i class="fas fa-pause"></i>
                    </button>
                    <input type="range" id="timelineSlider" min="0" max="100" value="0">
                    <span id="currentTime">00:00</span> / <span id="duration">00:00</span>
                </div>
                
                <div class="secondary-controls">
                    <button onclick="syncSeekBackward()" class="control-btn">
                        <i class="fas fa-backward"></i> 10s
                    </button>
                    <select onchange="videoControls.setPlaybackSpeed(this.value)">
                        <option value="0.5">0.5x</option>
                        <option value="1" selected>1x</option>
                        <option value="1.5">1.5x</option>
                        <option value="2">2x</option>
                    </select>
                    <button onclick="syncSeekForward()" class="control-btn">
                        10s <i class="fas fa-forward"></i>
                    </button>
                    <button onclick="videoControls.takeSnapshot()" class="control-btn">
                        <i class="fas fa-camera"></i>
                    </button>
                </div>

                <div class="volume-controls">
                    <i class="fas fa-volume-up"></i>
                    <input type="range" 
                           onchange="videoControls.setVolume(this.value)" 
                           min="0" max="1" step="0.1" value="1">
                    <button onclick="videoControls.toggleMute()" class="control-btn">
                        <i class="fas fa-volume-mute"></i>
                    </button>
                </div>
            </div>

            <!-- Reaction Bar -->
            <div class="reaction-bar"></div>
        </div>

        <!-- Updated Chat Section -->
        <div class="chat-section">
            <div class="chat-tabs">
                <button onclick="switchTab('chat')" class="active">Chat</button>
                <button onclick="switchTab('files')">Shared Files</button>
            </div>

            <div id="chatBox" class="chat-box tab-content active"></div>
            <div id="filesBox" class="files-box tab-content">
                <div class="file-list"></div>
                <div class="upload-area" ondrop="handleFileDrop(event)" ondragover="handleDragOver(event)">
                    <i class="fas fa-cloud-upload-alt"></i>
                    <p>Drag & Drop files here</p>
                    <input type="file" id="fileInput" onchange="handleFileShare(event)" multiple>
                    <button onclick="document.getElementById('fileInput').click()">Select Files</button>
                </div>
            </div>

            <div class="message-input-container">
                <button onclick="toggleEmojiPicker()" class="emoji-button">ðŸ˜Š</button>
                <div id="emojiPicker" class="emoji-picker" style="display: none;"></div>
                <input type="text" id="messageInput" placeholder="Type a message...">
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="roomSettingsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Room Settings</h2>
            <div class="settings-form">
                <div class="input-group">
                    <label>Room Password</label>
                    <input type="password" id="newRoomPassword">
                    <button onclick="roomFeatures.setRoomPassword(document.getElementById('newRoomPassword').value)">
                        Update Password
                    </button>
                </div>
                <div class="input-group">
                    <label>Room Access</label>
                    <select id="roomAccess">
                        <option value="public">Public</option>
                        <option value="private">Private</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div id="analyticsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Room Analytics</h2>
            <div id="analyticsContent"></div>
        </div>
    </div>

    <!-- Additional CSS -->
    <style>
        /* Section Styles */
        .user-section, .video-section, .chat-section {
            background: rgba(0, 0, 0, 0.8);
            border-radius: 10px;
            padding: 20px;
            backdrop-filter: blur(10px);
        }

        /* User Section */
        .user-list {
            margin-top: 15px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Video Section */
        .video-player {
            width: 100%;
            aspect-ratio: 16/9;
            background: #000;
            margin: 15px 0;
            border-radius: 5px;
            overflow: hidden;
        }

        .playback-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
        }

        /* Chat Section */
        .chat-box {
            height: calc(100% - 60px);
            overflow-y: auto;
            padding: 10px;
        }

        .message {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .sent {
            background: #ff0000;
            margin-left: auto;
        }

        .received {
            background: #333;
            margin-right: auto;
        }

        .message-input-container {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 5px;
            margin-top: 10px;
        }

        /* Emoji Picker */
        .emoji-picker {
            position: absolute;
            bottom: 100%;
            left: 0;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 5px;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }

        .emoji-picker span {
            cursor: pointer;
            padding: 5px;
            text-align: center;
            transition: transform 0.2s ease;
        }

        .emoji-picker span:hover {
            transform: scale(1.2);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-50px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        .form-slide {
            animation: slideIn 0.5s ease-out;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr 2fr;
            }
            .user-section {
                display: none;
            }
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
            }
            .chat-section {
                height: 300px;
            }
        }
    </style>

    <!-- Add this after your closing </style> tag and before </body>-->
    <script>
    // Global Variables
    let roomId;
    let userName;
    let isAdmin = false;
    let videoElement = null;

    // Video Controls Object
    const videoControls = {
        setPlaybackSpeed(speed) {
            if (!videoElement) return;
            videoElement.playbackRate = parseFloat(speed);
            broadcastVideoState('speed', speed);
        },
        
        setVolume(volume) {
            if (!videoElement) return;
            videoElement.volume = parseFloat(volume);
        },
        
        toggleMute() {
            if (!videoElement) return;
            videoElement.muted = !videoElement.muted;
        },
        
        takeSnapshot() {
            if (!videoElement) return;
            const canvas = document.createElement('canvas');
            canvas.width = videoElement.videoWidth;
            canvas.height = videoElement.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(videoElement, 0, 0);
            
            // Create download link
            const link = document.createElement('a');
            link.download = 'snapshot.png';
            link.href = canvas.toDataURL();
            link.click();
        }
    };

    // Initialize all features
    async function initializeApp() {
        try {
            videoElement = document.createElement('video');
            videoElement.id = 'mainVideo';
            document.getElementById('videoPlayer').appendChild(videoElement);
            
            // Add event listeners
            videoElement.addEventListener('loadedmetadata', () => {
                document.getElementById('duration').textContent = formatTime(videoElement.duration);
                document.querySelector('.playback-controls').style.display = 'flex';
            });
            
            videoElement.addEventListener('timeupdate', () => {
                document.getElementById('currentTime').textContent = formatTime(videoElement.currentTime);
                document.getElementById('timelineSlider').value = 
                    (videoElement.currentTime / videoElement.duration) * 100;
            });

            await initializeSupabase();
            initializeVideoChat();
            initializeChat();
            setupReactions();
            setupFileSharing();
            setupEventListeners();
            initializeTheme();
        } catch (error) {
            showError('Initialization failed: ' + error.message);
        }
    }

    // Video Chat Implementation
    async function initializeVideoChat() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });
            
            addVideoStream(stream, userName, true);
            setupPeerConnections(stream);
        } catch (error) {
            console.error('Failed to access camera:', error);
            showError('Camera access denied');
        }
    }

    function setupPeerConnections(stream) {
        supabase
            .channel('video-users')
            .on('presence', { event: 'join' }, ({ key, newPresence }) => {
                if (key !== userName) {
                    createPeerConnection(key, stream);
                }
            })
            .subscribe();
    }

    // Screen Sharing Implementation
    async function startScreenShare() {
        try {
            screenStream = await navigator.mediaDevices.getDisplayMedia({
                video: { cursor: "always" },
                audio: { echoCancellation: true, noiseSuppression: true }
            });

            videoElement = document.createElement('video');
            videoElement.id = 'sharedScreen';
            videoElement.autoplay = true;
            
            const videoPlayer = document.getElementById('videoPlayer');
            videoPlayer.innerHTML = '';
            videoPlayer.appendChild(videoElement);
            videoElement.srcObject = screenStream;
            
            toggleScreenShareControls(true);
            broadcastScreenShareState('started');
            
            screenStream.getVideoTracks()[0].onended = () => stopScreenShare();
        } catch (error) {
            showError('Screen sharing failed: ' + error.message);
        }
    }

    // File Sharing Implementation
    function setupFileSharing() {
        const dropZone = document.querySelector('.upload-area');
        
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        
        dropZone.addEventListener('drop', handleFileDrop);
    }

    async function handleFileShare(event) {
        const files = event.target.files || event.dataTransfer.files;
        
        for (const file of files) {
            const progressBar = createProgressBar(file.name);
            
            try {
                const { data, error } = await supabase.storage
                    .from('shared-files')
                    .upload(`${roomId}/${file.name}`, file, {
                        onProgress: (progress) => {
                            updateProgressBar(progressBar, progress);
                        }
                    });

                if (error) throw error;
                
                await sendFileMessage(data.path, file.name);
                removeProgressBar(progressBar);
            } catch (error) {
                showError(`Failed to upload ${file.name}`);
                removeProgressBar(progressBar);
            }
        }
    }

    // Chat Implementation
    function setupChat() {
        const messageInput = document.getElementById('messageInput');
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
    }

    async function sendMessage(content, type = 'text') {
        if (!content && type === 'text') {
            content = document.getElementById('messageInput').value.trim();
            if (!content) return;
        }

        try {
            const { error } = await supabase
                .from('messages')
                .insert([{
                    room_id: roomId,
                    sender: userName,
                    content: content,
                    type: type
                }]);

            if (error) throw error;
            
            if (type === 'text') {
                document.getElementById('messageInput').value = '';
            }
        } catch (error) {
            showError('Failed to send message');
        }
    }

    // Reactions Implementation
    function setupReactions() {
        const reactions = ['ðŸ‘', 'â¤ï¸', 'ðŸ˜‚', 'ðŸ˜®', 'ðŸ˜¢', 'ðŸ˜¡'];
        const reactionBar = document.querySelector('.reaction-bar');
        
        reactions.forEach(emoji => {
            const button = document.createElement('button');
            button.className = 'reaction-btn';
            button.textContent = emoji;
            button.onclick = () => sendReaction(emoji);
            reactionBar.appendChild(button);
        });
    }

    function sendReaction(emoji) {
        createFloatingReaction(emoji);
        broadcastReaction(emoji);
    }

    // Theme Implementation
    function initializeTheme() {
        const savedTheme = localStorage.getItem('theme') || 'default';
        applyTheme(savedTheme);
    }

    function applyTheme(themeName) {
        const theme = themes[themeName];
        if (!theme) return;
        
        Object.entries(theme).forEach(([property, value]) => {
            document.documentElement.style.setProperty(`--${property}`, value);
        });
        
        currentTheme = themeName;
        localStorage.setItem('theme', themeName);
    }

    // Utility Functions
    function showError(message) {
        Toastify({
            text: message,
            duration: 3000,
            gravity: "top",
            position: "right",
            backgroundColor: "linear-gradient(to right, #ff0000, #ff5555)",
            stopOnFocus: true
        }).showToast();
    }

    function createProgressBar(fileName) {
        const progressContainer = document.createElement('div');
        progressContainer.className = 'progress-container';
        progressContainer.innerHTML = `
            <span>${fileName}</span>
            <div class="progress-bar">
                <div class="progress-bar-fill"></div>
            </div>
        `;
        document.querySelector('.file-list').appendChild(progressContainer);
        return progressContainer;
    }

    // Helper function to format time
    function formatTime(seconds) {
        const minutes = Math.floor(seconds / 60);
        seconds = Math.floor(seconds % 60);
        return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', initializeApp);

    // UI Control Functions
    function showCreateRoomForm() {
        document.getElementById('initialButtons').style.display = 'none';
        document.getElementById('createRoomForm').style.display = 'block';
    }

    function showJoinRoomForm() {
        document.getElementById('initialButtons').style.display = 'none';
        document.getElementById('joinRoomForm').style.display = 'block';
    }

    function showInitialButtons() {
        document.getElementById('initialButtons').style.display = 'block';
        document.getElementById('createRoomForm').style.display = 'none';
        document.getElementById('joinRoomForm').style.display = 'none';
    }

    // Room Control Functions
    async function handleCreateRoom(event) {
        event.preventDefault();
        const userName = document.getElementById('newUserName').value;
        const roomName = document.getElementById('newMeetingName').value;
        const password = document.getElementById('newRoomPassword').value;

        try {
            const { data, error } = await supabase
                .from('rooms')
                .insert([
                    { name: roomName, password: password, admin_name: userName }
                ])
                .select()
                .single();

            if (error) throw error;
            
            // Store room info and enter
            roomId = data.id;
            isAdmin = true;
            enterRoom();
        } catch (error) {
            showError('Failed to create room: ' + error.message);
        }
    }

    async function handleJoinRoom(event) {
        event.preventDefault();
        const userName = document.getElementById('userName').value;
        const roomName = document.getElementById('meetingName').value;
        const password = document.getElementById('roomPassword').value;

        try {
            const { data, error } = await supabase
                .from ('rooms')
                .select()
                .eq('name', roomName)
                .eq('password', password)
                .single();

            if (error) throw error;
            
            // Store room info and enter
            roomId = data.id;
            isAdmin = false;
            enterRoom();
        } catch (error) {
            showError('Failed to join room: ' + error.message);
        }
    }

    // Video Control Functions
    function syncPlay() {
        if (videoElement) {
            videoElement.play();
            broadcastVideoState('play');
        }
    }

    function syncPause() {
        if (videoElement) {
            videoElement.pause();
            broadcastVideoState('pause');
        }
    }

    function syncSeekBackward() {
        if (videoElement) {
            videoElement.currentTime -= 10;
            broadcastVideoState('seek', videoElement.currentTime);
        }
    }

    function syncSeekForward() {
        if (videoElement) {
            videoElement.currentTime += 10;
            broadcastVideoState('seek', videoElement.currentTime);
        }
    }

    async function broadcastVideoState(action, value = null) {
        try {
            await supabase
                .from('video_states')
                .insert([{
                    room_id: roomId,
                    action: action,
                    value: value,
                    sender: userName
                }]);
        } catch (error) {
            console.error('Failed to broadcast video state:', error);
        }
    }

    // Add this after your global variables and before other functions
    async function initializeSupabase() {
        try {
            // Set up real-time subscriptions
            const { data: { user } } = await supabase.auth.getUser();
            
            // Subscribe to room changes
            const roomChannel = supabase
                .channel('room_changes')
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'rooms'
                }, handleRoomChange)
                .subscribe();

            // Subscribe to video state changes
            const videoChannel = supabase
                .channel('video_states')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'video_states'
                }, handleVideoStateChange)
                .subscribe();

            // Subscribe to chat messages
            const chatChannel = supabase
                .channel('chat_messages')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'messages'
                }, handleNewMessage)
                .subscribe();

            console.log('Supabase initialized successfully');
        } catch (error) {
            console.error('Failed to initialize Supabase:', error);
            throw new Error('Failed to initialize Supabase: ' + error.message);
        }
    }

    // Add these handler functions
    async function handleRoomChange(payload) {
        const { eventType, new: newRoom, old: oldRoom } = payload;
        
        if (eventType === 'DELETE' && oldRoom.id === roomId) {
            // Room was deleted
            showError('Room has been deleted');
            window.location.reload();
        } else if (eventType === 'UPDATE' && newRoom.id === roomId) {
            // Room was updated
            // Handle room updates (e.g., password change, settings change)
            if (isAdmin) {
                console.log('Room updated:', newRoom);
            }
        }
    }

    async function handleVideoStateChange(payload) {
        const { new: state } = payload;
        
        // Ignore own broadcasts
        if (state.sender === userName) return;
        
        // Handle different video state changes
        switch (state.action) {
            case 'play':
                videoElement?.play();
                break;
            case 'pause':
                videoElement?.pause();
                break;
            case 'seek':
                if (videoElement && state.value !== null) {
                    videoElement.currentTime = state.value;
                }
                break;
            case 'speed':
                if (videoElement && state.value !== null) {
                    videoElement.playbackRate = state.value;
                }
                break;
        }
    }

    async function handleNewMessage(payload) {
        const { new: message } = payload;
        
        // Only handle messages for current room
        if (message.room_id !== roomId) return;
        
        // Add message to chat
        addMessageToChat(message);
    }

    function addMessageToChat(message) {
        const chatBox = document.getElementById('chatBox');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${message.sender === userName ? 'sent' : 'received'}`;
        
        // Handle different message types
        switch (message.type) {
            case 'text':
                messageDiv.textContent = `${message.sender}: ${message.content}`;
                break;
            case 'file':
                const fileLink = document.createElement('a');
                fileLink.href = message.content;
                fileLink.textContent = `ðŸ“Ž ${message.sender} shared a file`;
                fileLink.target = '_blank';
                messageDiv.appendChild(fileLink);
                break;
            case 'reaction':
                messageDiv.textContent = `${message.sender} reacted with ${message.content}`;
                break;
        }
        
        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }
    </script>
</body>
</html>
