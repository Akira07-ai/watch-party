<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arcane Watch Party</title>
    
    <!-- External Dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/appwrite@11.0.0"></script>
    <script src="https://unpkg.com/simple-peer@9.11.0/simplepeer.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.2/toastify.min.js"></script>

    <style>
        :root {
            --primary-color: #7e57c2;
            --secondary-color: #b085f5;
            --background-color: #121212;
            --surface-color: #1e1e1e;
            --text-color: #ffffff;
            --error-color: #cf6679;
            --success-color: #03dac6;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
        }

        body {
            margin: 0;
            font-family: 'Arial', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .container {
            display: none;
            grid-template-columns: 1fr 300px;
            height: 100vh;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
        }

        .video-container {
            background: var(--surface-color);
            border-radius: 8px;
            padding: var(--spacing-md);
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            background: var(--surface-color);
            border-radius: 8px;
            padding: var(--spacing-md);
        }

        #chatBox {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-md);
        }

        .message {
            margin-bottom: var(--spacing-md);
            padding: var(--spacing-sm);
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            word-wrap: break-word;
        }

        .message.sent {
            background: var(--primary-color);
            margin-left: 20%;
        }

        .message.received {
            background: rgba(255, 255, 255, 0.1);
            margin-right: 20%;
        }

        .sender {
            font-weight: bold;
            font-size: 0.9em;
            display: block;
        }

        .timestamp {
            font-size: 0.8em;
            opacity: 0.7;
            display: block;
        }

        .input-container {
            display: flex;
            gap: var(--spacing-sm);
        }

        #messageInput {
            flex-grow: 1;
            padding: var(--spacing-sm);
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        button {
            background: var(--primary-color);
            color: var(--text-color);
            border: none;
            border-radius: 4px;
            padding: var(--spacing-sm) var(--spacing-md);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        button:hover {
            background: var(--secondary-color);
        }

        #initialForms {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            gap: var(--spacing-lg);
        }

        .form-container {
            background: var(--surface-color);
            padding: var(--spacing-lg);
            border-radius: 8px;
            width: 300px;
        }

        .form-container h2 {
            margin-top: 0;
            color: var(--primary-color);
        }

        input {
            width: 100%;
            padding: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            border: none;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        .reactions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
        }

        .reaction-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            padding: 4px;
            transition: transform 0.2s;
        }

        .reaction-btn:hover {
            transform: scale(1.2);
        }

        .floating-reaction {
            position: fixed;
            animation: float 1s ease-out forwards;
            pointer-events: none;
            font-size: 2em;
        }

        @keyframes float {
            0% {
                transform: translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateY(-100px);
                opacity: 0;
            }
        }

        .theme-toggle {
            position: fixed;
            top: var(--spacing-md);
            right: var(--spacing-md);
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            font-size: 1.5em;
        }

        .file-upload button {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: var(--spacing-sm);
        }

        .file-link {
            color: var(--primary-color);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        #adminControls {
            display: none;
            margin-top: var(--spacing-md);
        }
    </style>
</head>
<body>
    <div id="initialForms">
        <div class="form-container">
            <h2>Create Room</h2>
            <form id="createRoomForm">
                <input type="text" id="newUserName" placeholder="Your Name" required>
                <input type="text" id="newMeetingName" placeholder="Room Name" required>
                <input type="password" id="newRoomPassword" placeholder="Room Password" required>
                <button type="submit">Create Room</button>
            </form>
        </div>

        <div class="form-container">
            <h2>Join Room</h2>
            <form id="joinRoomForm">
                <input type="text" id="userName" placeholder="Your Name" required>
                <input type="text" id="meetingName" placeholder="Room Name" required>
                <input type="password" id="roomPassword" placeholder="Room Password" required>
                <button type="submit">Join Room</button>
            </form>
        </div>
    </div>

    <div class="container">
        <div class="video-container">
            <video id="localVideo" autoplay muted></video>
            <div id="remoteVideos"></div>
            <div id="adminControls">
                <button onclick="toggleMute()">Toggle Mute</button>
                <button onclick="toggleVideo()">Toggle Video</button>
            </div>
        </div>

        <div class="chat-container">
            <div id="chatBox"></div>
            <div class="reactions">
                <button class="reaction-btn" onclick="sendReaction('üëç')">üëç</button>
                <button class="reaction-btn" onclick="sendReaction('‚ù§Ô∏è')">‚ù§Ô∏è</button>
                <button class="reaction-btn" onclick="sendReaction('üòÇ')">üòÇ</button>
                <button class="reaction-btn" onclick="sendReaction('üòÆ')">üòÆ</button>
                <button class="reaction-btn" onclick="sendReaction('üëè')">üëè</button>
            </div>
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Type a message...">
                <div class="file-upload">
                    <input type="file" id="fileInput" style="display: none;">
                    <button onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                </div>
                <button onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <button class="theme-toggle" onclick="toggleTheme()">
        <i class="fas fa-moon"></i>
    </button>

    <script>
        // Initialize Appwrite with your IDs
        const client = new Appwrite();
        client
            .setEndpoint('https://cloud.appwrite.io/v1')
            .setProject('672fc0e90039900958a6');

        // Initialize services
        const databases = new Appwrite.Databases(client);
        const storage = new Appwrite.Storage(client);

        // Your provided IDs
        const DATABASE_ID = '672fc3900004496acb05';
        const ROOMS_COLLECTION_ID = '672fc3c2000ad4fdc148';
        const MESSAGES_COLLECTION_ID = '672fc5a3001ba8defed8';
        const REACTIONS_COLLECTION_ID = '67303c86002e4a6021a2';
        const STORAGE_BUCKET_ID = '6730400800147945b7ac';

        // Global Variables
        let roomId;
        let userName;
        let isAdmin = false;

        // Event Listeners
        document.getElementById('createRoomForm').addEventListener('submit', handleCreateRoom);
        document.getElementById('joinRoomForm').addEventListener('submit', handleJoinRoom);
        document.getElementById('messageInput').addEventListener('keypress', handleMessageKeyPress);
        document.getElementById('fileInput').addEventListener('change', handleFileUpload);

        // Room Management Functions
        async function handleCreateRoom(event) {
            event.preventDefault();
            try {
                userName = document.getElementById('newUserName').value;
                const roomName = document.getElementById('newMeetingName').value;
                const password = document.getElementById('newRoomPassword').value;

                const document = await databases.createDocument(
                    DATABASE_ID,
                    ROOMS_COLLECTION_ID,
                    ID.unique(),
                    {
                        name: roomName,
                        password: password,
                        admin_name: userName,
                        created_at: new Date().toISOString()
                    }
                );

                roomId = document.$id;
                isAdmin = true;
                enterRoom();
                showSuccess('Room created successfully!');
            } catch (error) {
                showError('Failed to create room: ' + error.message);
            }
        }

        async function handleJoinRoom(event) {
            event.preventDefault();
            try {
                userName = document.getElementById('userName').value;
                const roomName = document.getElementById('meetingName').value;
                const password = document.getElementById('roomPassword').value;

                const response = await databases.listDocuments(
                    DATABASE_ID,
                    ROOMS_COLLECTION_ID,
                    [
                        Query.equal('name', roomName),
                        Query.equal('password', password)
                    ]
                );

                if (response.documents.length === 0) {
                    throw new Error('Invalid room name or password');
                }

                roomId = response.documents[0].$id;
                isAdmin = response.documents[0].admin_name === userName;
                enterRoom();
                showSuccess('Joined room successfully!');
            } catch (error) {
                showError('Failed to join room: ' + error.message);
            }
        }

        // Chat Functions
        function setupChat() {
            client.subscribe(`databases.${DATABASE_ID}.collections.${MESSAGES_COLLECTION_ID}.documents`, 
                response => {
                    if (response.events.includes('databases.*.collections.*.documents.*.create')) {
                        handleNewMessage(response.payload);
                    }
                }
            );

            client.subscribe(`databases.${DATABASE_ID}.collections.${REACTIONS_COLLECTION_ID}.documents`, 
                response => {
                    if (response.events.includes('databases.*.collections.*.documents.*.create')) {
                        handleNewReaction(response.payload);
                    }
                }
            );
        }

        async function handleMessageKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                await sendMessage();
            }
        }

        async function sendMessage(content = null, type = 'text') {
            try {
                const messageInput = document.getElementById('messageInput');
                const messageContent = content || messageInput.value.trim();
                
                if (!messageContent) return;

                await databases.createDocument(
                    DATABASE_ID,
                    MESSAGES_COLLECTION_ID,
                    ID.unique(),
                    {
                        room_id: roomId,
                        type: type,
                        content: messageContent,
                        sender: userName,
                        timestamp: new Date().toISOString()
                    }
                );

                if (type === 'text') {
                    messageInput.value = '';
                }
            } catch (error) {
                showError('Failed to send message: ' + error.message);
            }
        }

        // File Handling
        async function handleFileUpload(event) {
            const file = event.target.files[0];
            try {
                const uploadedFile = await storage.createFile(
                    STORAGE_BUCKET_ID,
                    ID.unique(),
                    file
                );

                const fileUrl = storage.getFileView(
                    STORAGE_BUCKET_ID,
                    uploadedFile.$id
                );

                await sendMessage({
                    url: fileUrl,
                    name: file.name,
                    size: file.size
                }, 'file');

                showSuccess('File shared successfully');
            } catch (error) {
                showError('File upload failed: ' + error.message);
            }
        }

        // Reactions System
        async function sendReaction(emoji) {
            try {
                await databases.createDocument(
                    DATABASE_ID,
                    REACTIONS_COLLECTION_ID,
                    ID.unique(),
                    {
                        room_id: roomId,
                        emoji: emoji,
                        sender: userName,
                        timestamp: new Date().toISOString()
                    }
                );

                showReactionAnimation(emoji);
            } catch (error) {
                showError('Failed to send reaction: ' + error.message);
            }
        }

        function showReactionAnimation(emoji) {
            const reaction = document.createElement('div');
            reaction.className = 'floating-reaction';
            reaction.textContent = emoji;
            reaction.style.left = `${Math.random() * 80 + 10}%`;
            document.body.appendChild(reaction);
            setTimeout(() => reaction.remove(), 1000);
        }

        // UI Functions
        function enterRoom() {
            document.getElementById('initialForms').style.display = 'none';
            document.querySelector('.container').style.display = 'grid';
            if (isAdmin) {
                document.getElementById('adminControls').style.display = 'block';
            }
            setupChat();
            loadChatHistory();
        }

        function toggleTheme() {
            const root = document.documentElement;
            const isDark = getComputedStyle(root).getPropertyValue('--background-color').trim() === '#121212';
            
            if (isDark) {
                root.style.setProperty('--background-color', '#ffffff');
                root.style.setProperty('--surface-color', '#f5f5f5');
                root.style.setProperty('--text-color', '#000000');
            } else {
                root.style.setProperty('--background-color', '#121212');
                root.style.setProperty('--surface-color', '#1e1e1e');
                root.style.setProperty('--text-color', '#ffffff');
            }
        }

        // Utility Functions
        function showSuccess(message) {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: 'right',
                backgroundColor: "var(--success-color)",
            }).showToast();
        }

        function showError(message) {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: 'right',
                backgroundColor: "var(--error-color)",
            }).showToast();
        }

        function formatTimestamp(timestamp) {
            return new Date(timestamp).toLocaleTimeString();
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        async function loadChatHistory() {
            try {
                const response = await databases.listDocuments(
                    DATABASE_ID,
                    MESSAGES_COLLECTION_ID,
                    [
                        Query.equal('room_id', roomId),
                        Query.orderAsc('timestamp')
                    ]
                );

                response.documents.forEach(message => {
                    handleNewMessage(message);
                });
            } catch (error) {
                showError('Failed to load chat history: ' + error.message);
            }
        }

        function handleNewMessage(message) {
            const chatBox = document.getElementById('chatBox');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.sender === userName ? 'sent' : 'received'}`;

            if (message.type === 'file') {
                messageDiv.innerHTML = `
                    <span class="sender">${escapeHtml(message.sender)}</span>
                    <a href="${message.content.url}" target="_blank" class="file-link">
                        üìé ${escapeHtml(message.content.name)} (${formatFileSize(message.content.size)})
                    </a>
                    <span class="timestamp">${formatTimestamp(message.timestamp)}</span>
                `;
            } else {
                messageDiv.innerHTML = `
                    <span class="sender">${escapeHtml(message.sender)}</span>
                    <span class="content">${escapeHtml(message.content)}</span>
                    <span class="timestamp">${formatTimestamp(message.timestamp)}</span>
                `;
            }

            chatBox.appendChild(messageDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }
    </script>
</body>
</html>
